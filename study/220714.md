# Create Account

## password hashing
- DB에 패스워드를 노출되게 저장하면 안됨. (보안 문제로 암호화해야 함.)

### Hash
- **일방향 함수** (무조건 비밀번호 -> 해시 값)
- `123123` -> `kajlksjdlifjsld`이상한 문자열로 바꿔주는 것.
  - DB에 비밀번호를 저장할 때 랜덤한 값으로 저장시켜주는 것.
- 같은 값을 입력하면 같은 해싱 값이 나옴. (deterministic function 결정적 함수)


### <a href="https://emn178.github.io/online-tools/sha256.html">해시함수 테스트</a>

### <a href="https://www.npmjs.com/package/bcrypt">node.bcrypt.js</a>
- 해싱할 때 사용.
- > npm i bcrypt
```
userSchema.pre("save", async function () {
  console.log("users password:", this.password);
  this.password = await bcrypt.hash(this.password, 5);
  console.log("hashed password", this.password);
});
```
- ` bcrypt.hash(암호화 될 data, saltRounds)`

#### saltRounds
- password를 더 예측하기 어렵게 만들어줌.
- 해시값을 한번 더 해싱함. (5를 입력하면 5번 랜덤하게 돌려서 해시값을 출력)

## 중복 값일 때, 에러 표시
### $or operator
```
const usernameExists = await User.exists({ username });
  if (usernameExists) {
    res.render("join", {
      pageTitle,
      errorMessage: "This username is already taken",
    });
  }

  const emailExists = await User.exists({ email });
  if (emailExists) {
    res.render("join", {
      pageTitle,
      errorMessage: "This email is already taken",
    });
  }
  ```
  - 위 코드 `usernameExists`, `emailExists`는 중복됨.
  - 중복을 피하기 위해 `$or`를 사용.

- 각 조건이 true일 때 실행
- $or 연산자는 둘 이상의 조건에 대해 논리적 OR 연산을 수행하고 조건 중 하나 이상을 충족하는 문서를 선택함.
- `{$or: [ {<expression1>}, {<expression2>}, ... , {<expressionN>}] }
#### 결과
```
const exists = await User.exists({ $or: [{ username }, { email }] });
  if (exists) {
    return res.render("join", {
      pageTitle,
      errorMessage: "This username/email is already taken",
    });
  }
 ```

## password체크
 ```
 if (password !== password2) {
    return res.render("join", {
      pageTitle,
      errorMessage: "Password confirmation does not match.",
    });
  }
 ```

## Status Codes
**계정이 생성이 안됐는데 아이디와 비밀번호를 저장하겠냐는 알림이 뜨는 것을 방지하기 위함.**
<img src="https://user-images.githubusercontent.com/97646713/178962983-6d8dcc57-f97d-4064-955b-57313dfdf7be.png">
- 이미지처럼 브라우저는 `200`을 받았기 때문에 계정 생성이 잘 됐다고 판단을 함!!
- **Status Codes** 는 브라우저가 서버에 대한 요청을 받아들이는 코드.
  - `2xx` : (OK) 성공
  - `4xx` : (Bad Request) 실패. 서버가 요청의 구문을 인식하지 못할 때 발생. 클라이언트 측에서 문제가 있을 때 주로 발생.
  - `404` : (Not Found) 서버가 요청한 페이지를 찾을 수 없을 때 발생. 서버에 존재하지 않는 페이지에 대한 요청이 있을 경우 서버는 이 코드를 제공함.

- **`.status(404)`를 설정해야 하는 이유**
  - 브라우저에서 유저가 방문한 웹사이트의 히스토리를 저장하는데 `200`으로 놔두면 정상적으로 방문했다고 히스토리에 기록을 남김. 하지만 `4xx`은 url을 히스토리에 남기지 않음. 
  - 즉, 브라우저가 적절한 행동을 취할 수 있도록 `.status()` 설정해줘야 함.

```
if (exists) {
    return res.status(400).render("join", {
      pageTitle,
      errorMessage: "This username/email is already taken",
    });
  }
```
- `status(400)`를 추가하면 에러로 인식해서 알림이 뜨지 않음.
